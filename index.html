<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body, .leaflet-container, .drobot-title {
            font-family: 'Montserrat', sans-serif !important;
        }
        
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }


        #map {
            width: 100%;
            height: calc(100vh - 60px) !important;
            margin-top: 0;
            background-color: #f0f0f0;}
        

        #top-bar {
            height: 60px;
            background: linear-gradient(90deg, #0b1c2c 0%, #1a2e40 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 3000;
            position: relative;
        }

        .logo-area {
            display: flex;
            align-items: center; 
            height: 100%;
        }

        #drobot-logo { 
            height: 34px; 
            width: auto;
            margin-right: 15px; 
            display: block; 
        }

        .drobot-title { 
            font-weight: 700; 
            font-size: 19px;
            letter-spacing: 0.5px;
            line-height: 1;
            position: relative;
            top: 1px;
        }

        .client-area { 
            font-size: 13px; 
            color: rgba(255,255,255,0.8); 
            border-left: 1px solid rgba(255,255,255,0.2); 
            padding-left: 20px; 
            font-weight: 500;
            height: 30px;
            display: flex;
            align-items: center;
        }

        /* --- 3. CONTROLES DEL MAPA (Aqu√≠ est√° la magia visual) --- */
        
        .leaflet-bar {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            border: none !important;
            border-radius: 8px !important;
            overflow: hidden;
        }

        .leaflet-bar a, 
        .leaflet-control-layers-toggle {
            background-color: white !important;
            color: #444 !important;
            width: 36px !important;
            height: 36px !important;
            line-height: 36px !important;
            font-weight: bold !important;
            border-bottom: 1px solid #f0f0f0 !important;
            transition: all 0.2s ease;
        }

        .leaflet-bar a:hover {
            background-color: #f8f9fa !important;
            color: #0b1c2c !important;
            transform: translateY(-1px);
        }

        /* --- 4. MEN√ö DE CAPAS (Derecha) --- */
        .leaflet-control-layers {
            border: none !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15) !important;
            padding: 15px !important;
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(5px);
        }

        .leaflet-control-layers-group-label {
            color: #0b1c2c;
            font-weight: 700;
            font-size: 14px;
            margin-top: 8px;
            display: block;
            border-bottom: 2px solid #eee;
            padding-bottom: 4px;
            margin-bottom: 8px;
        }

        .leaflet-control-layers label {
            margin-bottom: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .leaflet-control-layers label:hover {
            color: #007bff;
        }

        /* --- 5. POPUPS (Las ventanitas al dar clic) --- */
        .leaflet-popup-content-wrapper {
            border-radius: 12px !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2) !important;
            padding: 0 !important;
            overflow: hidden;
        }
        
        .leaflet-popup-content {
            margin: 15px !important;
            line-height: 1.6;
            font-size: 13px;
        }
        
        .leaflet-popup-content h3 {
            background: #0b1c2c;
            color: white;
            margin: -15px -15px 10px -15px;
            padding: 10px 15px;
            font-size: 14px;
        }

        /* --- 6. UTILIDADES --- */
        /* Separar controles de la barra superior */
        .leaflet-top { top: 20px; }
        .leaflet-left { left: 20px; }
        .leaflet-right { right: 20px; }

        /* Esconder capa master (Vital) */
        .css_Alumbradopostes_12 { display: none !important; }

        /* --- 7. MEJORA DE POPUPS "PREMIUM" + VISOR GIGANTE --- */

        /* 1. OCULTAR FID (Igual que antes) */
        .leaflet-popup-content table tr:first-child { display: none !important; }

        /* 2. ESTILO TABLA (Igual que antes) */
        .leaflet-popup-content table {
            width: 100% !important; border-collapse: separate !important;
            border-spacing: 0 8px !important; font-size: 14px !important; margin: 10px 0 !important;
        }
        .leaflet-popup-content th {
            text-align: left !important; color: #888 !important; font-weight: 500 !important;
            vertical-align: top !important; width: 30% !important; padding-right: 5px !important;
        }
        .leaflet-popup-content td {
            text-align: left !important; color: #0b1c2c !important; font-weight: 700 !important;
            vertical-align: top !important; width: 70% !important; word-break: break-word !important;
        }

        /* 3. LA MINIATURA EN EL POPUP (SECCI√ìN CLAVE) */
        /* Hacemos que se vea bonita e indique que se puede hacer clic */
        .leaflet-popup-content td img, .leaflet-popup-content td a img {
            display: block !important; width: 100% !important; max-width: 300px !important;
            height: 200px !important; /* Altura fija para que se vea uniforme */
            object-fit: cover !important; /* Recorta la foto para llenar el cuadro sin deformar */
            border-radius: 12px !important;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2) !important;
            margin-top: 10px !important;
            cursor: zoom-in !important; /* <--- ESTO MUESTRA LA LUPA AL PASAR EL MOUSE */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        /* Efecto al pasar el mouse sobre la miniatura */
        .leaflet-popup-content td img:hover {
            transform: scale(1.03); /* Se agranda un poquito */
            box-shadow: 0 8px 20px rgba(0,0,0,0.3) !important;
        }

        /* 4. ESTILOS DEL VISOR PANTALLA COMPLETA (NUEVO) */
        /* El fondo negro transparente */
        .modal-overlay {
            display: none; /* Oculto por defecto */
            position: fixed; z-index: 99999; /* Por encima de TODO */
            padding-top: 50px; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.92); /* Negro profundo casi s√≥lido */
            backdrop-filter: blur(5px); /* Efecto borroso de fondo */
        }
        /* La imagen gigante */
        .modal-content {
            margin: auto; display: block; width: auto; height: auto;
            max-width: 90vw; /* M√°ximo 90% del ancho de la pantalla */
            max-height: 85vh; /* M√°ximo 85% del alto de la pantalla */
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: zoom 0.4s; /* Animaci√≥n de entrada */
        }
        /* Bot√≥n de cerrar (X) */
        .close-modal {
            position: absolute; top: 20px; right: 35px; color: #f1f1f1;
            font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer;
        }
        .close-modal:hover, .close-modal:focus { color: #bbb; text-decoration: none; cursor: pointer; }
        /* Animaci√≥n de zoom */
        @keyframes zoom { from {transform:scale(0.8); opacity:0} to {transform:scale(1); opacity:1} }
        
        /* Ajustes del contenedor del popup */
        .leaflet-popup-content { min-width: 320px !important; }
        .leaflet-popup-content-wrapper { border-radius: 16px !important; }
    </style>
        <title></title>
    </head>
    <body>
        <div id="top-bar">
        <div class="logo-area">
            <img src="logo.png" alt="Drobot Logo" id="drobot-logo">
            <span class="drobot-title">DROBOT | Gesti√≥n de Alumbrado</span>
        </div>
        <div class="client-area">
            <span>Kawatzin</span>
        </div>
    </div>
        <div id="map">
        </div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="data/Otro_6.js"></script>
        <script src="data/Intermitente_7.js"></script>
        <script src="data/Directa_8.js"></script>
        <script src="data/Daado_9.js"></script>
        <script src="data/Bueno_10.js"></script>
        <script src="data/Apagada_11.js"></script>
        <script src="data/Alumbradopostes_12.js"></script>
        <script>
        var highlightLayer;
        function highlightFeature(e) {
            highlightLayer = e.target;

            if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
              highlightLayer.setStyle({
                color: '#ffff00',
              });
            } else {
              highlightLayer.setStyle({
                fillColor: '#ffff00',
                fillOpacity: 1
              });
            }
        }
        var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:1
        })
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.update();
                    }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video');
                    video.controls = true;
                    video.src = src;
                    video.style.width = "400px";
                    video.style.height = "300px";
                    video.style.maxHeight = "60vh";
                    video.style.maxWidth = "60vw";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    video.addEventListener('loadedmetadata', function() {
                        popup.update();
                    });
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            } else {
                popup._contentNode.classList.remove('media');
            }
        }
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares'
        });
        measureControl.addTo(map);
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
            if (bounds_group.getLayers().length) {
                map.fitBounds(bounds_group.getBounds());
            }
        }
        map.createPane('pane_OpenStreetMap_0');
        map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
        var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OpenStreetMap_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_OpenStreetMap_0;
        
        map.createPane('pane_GoogleMaps_1');
        map.getPane('pane_GoogleMaps_1').style.zIndex = 401;
        var layer_GoogleMaps_1 = L.tileLayer('https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}', {
            pane: 'pane_GoogleMaps_1',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_GoogleMaps_1;
        
        map.createPane('pane_GoogleMapSatellite_2');
        map.getPane('pane_GoogleMapSatellite_2').style.zIndex = 402;
        var layer_GoogleMapSatellite_2 = L.tileLayer('http://www.google.cn/maps/vt?lyrs=s@189&gl=cn&x={x}&y={y}&z={z}', {
            pane: 'pane_GoogleMapSatellite_2',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_GoogleMapSatellite_2;
        map.addLayer(layer_GoogleMapSatellite_2);
        map.createPane('pane_GoogleSatelliteHybrid_3');
        map.getPane('pane_GoogleSatelliteHybrid_3').style.zIndex = 403;
        var layer_GoogleSatelliteHybrid_3 = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            pane: 'pane_GoogleSatelliteHybrid_3',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_GoogleSatelliteHybrid_3;
        
        map.createPane('pane_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4');
        map.getPane('pane_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4').style.zIndex = 404;
        var img_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4 = 'data/dji_fly_20250722_185244_0181_1769184310403_photo_modified_4.webp';
        var img_bounds_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4 = [[20.477305525524667,-97.44742707624859],[20.477688255136947,-97.44690449256086]];
        var layer_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4 = new L.imageOverlay(img_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4,
                                              img_bounds_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4,
                                              {pane: 'pane_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4'});
        bounds_group.addLayer(layer_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4);
        map.addLayer(layer_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4);
        map.createPane('pane_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5');
        map.getPane('pane_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5').style.zIndex = 405;
        var img_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5 = 'data/dji_fly_20250722_185256_0182_1769184314666_photo_modified_5.webp';
        var img_bounds_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5 = [[20.47713020129182,-97.44748035804977],[20.47751380984635,-97.44692639028311]];
        var layer_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5 = new L.imageOverlay(img_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5,
                                              img_bounds_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5,
                                              {pane: 'pane_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5'});
        bounds_group.addLayer(layer_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5);
        map.addLayer(layer_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5);
        function pop_Otro_6(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Id</th>\
                        <td class="visible-with-data" id="Id">' + (feature.properties['Id'] !== null ? autolinker.link(String(feature.properties['Id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Tipo</th>\
                        <td class="visible-with-data" id="Tipo">' + (feature.properties['Tipo'] !== null ? autolinker.link(String(feature.properties['Tipo']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Estado</th>\
                        <td class="visible-with-data" id="Estado">' + (feature.properties['Estado'] !== null ? autolinker.link(String(feature.properties['Estado']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Foto_evidencia</th>\
                        <td class="visible-with-data" id="Foto_evidencia">' + (feature.properties['Foto_evidencia'] !== null ? '<img src="images/' + String(feature.properties['Foto_evidencia']).replace(/[\\/:]/g, '_').trim().replace(/'/g, '\'').replace(/"/g, '&quot;') + '">' : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Observaciones</th>\
                        <td id="Observaciones">' + ((feature.properties['Observaciones'] !== null && feature.properties['Observaciones'] !== "") ? autolinker.link(String(feature.properties['Observaciones']).replace(/'/g, '\'').toLocaleString()) : 'ninguno') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Otro_6_0(feature) {
            switch(String(feature.properties['Estado'])) {
                case 'Otro':
                    return {
                pane: 'pane_Otro_6',
        rotationAngle: 0.0,
        rotationOrigin: 'center center',
        icon: L.icon({
            iconUrl: 'markers/Otro_6.svg',
            iconSize: [22.799999999999997, 22.799999999999997]
        }),
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_Otro_6');
        map.getPane('pane_Otro_6').style.zIndex = 406;
        map.getPane('pane_Otro_6').style['mix-blend-mode'] = 'normal';
        var layer_Otro_6 = new L.geoJson(json_Otro_6, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Otro_6',
            layerName: 'layer_Otro_6',
            pane: 'pane_Otro_6',
            onEachFeature: pop_Otro_6,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.marker(latlng, style_Otro_6_0(feature));
            },
        });
        bounds_group.addLayer(layer_Otro_6);
        map.addLayer(layer_Otro_6);
        function pop_Intermitente_7(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Id</th>\
                        <td class="visible-with-data" id="Id">' + (feature.properties['Id'] !== null ? autolinker.link(String(feature.properties['Id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Tipo</th>\
                        <td class="visible-with-data" id="Tipo">' + (feature.properties['Tipo'] !== null ? autolinker.link(String(feature.properties['Tipo']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Estado</th>\
                        <td class="visible-with-data" id="Estado">' + (feature.properties['Estado'] !== null ? autolinker.link(String(feature.properties['Estado']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Foto_evidencia</th>\
                        <td class="visible-with-data" id="Foto_evidencia">' + (feature.properties['Foto_evidencia'] !== null ? '<img src="images/' + String(feature.properties['Foto_evidencia']).replace(/[\\/:]/g, '_').trim().replace(/'/g, '\'').replace(/"/g, '&quot;') + '">' : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Observaciones</th>\
                        <td id="Observaciones">' + ((feature.properties['Observaciones'] !== null && feature.properties['Observaciones'] !== "") ? autolinker.link(String(feature.properties['Observaciones']).replace(/'/g, '\'').toLocaleString()) : 'ninguno') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Intermitente_7_0(feature) {
            switch(String(feature.properties['Estado'])) {
                case 'Intermitente':
                    return {
                pane: 'pane_Intermitente_7',
        rotationAngle: 0.0,
        rotationOrigin: 'center center',
        icon: L.icon({
            iconUrl: 'markers/Intermitente_7.svg',
            iconSize: [22.799999999999997, 22.799999999999997]
        }),
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_Intermitente_7');
        map.getPane('pane_Intermitente_7').style.zIndex = 407;
        map.getPane('pane_Intermitente_7').style['mix-blend-mode'] = 'normal';
        var layer_Intermitente_7 = new L.geoJson(json_Intermitente_7, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Intermitente_7',
            layerName: 'layer_Intermitente_7',
            pane: 'pane_Intermitente_7',
            onEachFeature: pop_Intermitente_7,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.marker(latlng, style_Intermitente_7_0(feature));
            },
        });
        bounds_group.addLayer(layer_Intermitente_7);
        map.addLayer(layer_Intermitente_7);
        function pop_Directa_8(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Id</th>\
                        <td class="visible-with-data" id="Id">' + (feature.properties['Id'] !== null ? autolinker.link(String(feature.properties['Id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Tipo</th>\
                        <td class="visible-with-data" id="Tipo">' + (feature.properties['Tipo'] !== null ? autolinker.link(String(feature.properties['Tipo']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Estado</th>\
                        <td class="visible-with-data" id="Estado">' + (feature.properties['Estado'] !== null ? autolinker.link(String(feature.properties['Estado']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Foto_evidencia</th>\
                        <td class="visible-with-data" id="Foto_evidencia">' + (feature.properties['Foto_evidencia'] !== null ? '<img src="images/' + String(feature.properties['Foto_evidencia']).replace(/[\\/:]/g, '_').trim().replace(/'/g, '\'').replace(/"/g, '&quot;') + '">' : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Observaciones</th>\
                        <td id="Observaciones">' + ((feature.properties['Observaciones'] !== null && feature.properties['Observaciones'] !== "") ? autolinker.link(String(feature.properties['Observaciones']).replace(/'/g, '\'').toLocaleString()) : 'ninguno') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Directa_8_0(feature) {
            switch(String(feature.properties['Estado'])) {
                case 'Directa':
                    return {
                pane: 'pane_Directa_8',
        rotationAngle: 0.0,
        rotationOrigin: 'center center',
        icon: L.icon({
            iconUrl: 'markers/Directa_8.svg',
            iconSize: [22.799999999999997, 22.799999999999997]
        }),
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_Directa_8');
        map.getPane('pane_Directa_8').style.zIndex = 408;
        map.getPane('pane_Directa_8').style['mix-blend-mode'] = 'normal';
        var layer_Directa_8 = new L.geoJson(json_Directa_8, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Directa_8',
            layerName: 'layer_Directa_8',
            pane: 'pane_Directa_8',
            onEachFeature: pop_Directa_8,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.marker(latlng, style_Directa_8_0(feature));
            },
        });
        bounds_group.addLayer(layer_Directa_8);
        map.addLayer(layer_Directa_8);
        function pop_Daado_9(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Id</th>\
                        <td class="visible-with-data" id="Id">' + (feature.properties['Id'] !== null ? autolinker.link(String(feature.properties['Id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Tipo</th>\
                        <td class="visible-with-data" id="Tipo">' + (feature.properties['Tipo'] !== null ? autolinker.link(String(feature.properties['Tipo']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Estado</th>\
                        <td class="visible-with-data" id="Estado">' + (feature.properties['Estado'] !== null ? autolinker.link(String(feature.properties['Estado']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Foto_evidencia</th>\
                        <td class="visible-with-data" id="Foto_evidencia">' + (feature.properties['Foto_evidencia'] !== null ? '<img src="images/' + String(feature.properties['Foto_evidencia']).replace(/[\\/:]/g, '_').trim().replace(/'/g, '\'').replace(/"/g, '&quot;') + '">' : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Observaciones</th>\
                        <td id="Observaciones">' + ((feature.properties['Observaciones'] !== null && feature.properties['Observaciones'] !== "") ? autolinker.link(String(feature.properties['Observaciones']).replace(/'/g, '\'').toLocaleString()) : 'ninguno') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Daado_9_0(feature) {
            switch(String(feature.properties['Estado'])) {
                case 'Da√±ado':
                    return {
                pane: 'pane_Daado_9',
        rotationAngle: 0.0,
        rotationOrigin: 'center center',
        icon: L.icon({
            iconUrl: 'markers/Daado_9.svg',
            iconSize: [22.799999999999997, 22.799999999999997]
        }),
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_Daado_9');
        map.getPane('pane_Daado_9').style.zIndex = 409;
        map.getPane('pane_Daado_9').style['mix-blend-mode'] = 'normal';
        var layer_Daado_9 = new L.geoJson(json_Daado_9, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Daado_9',
            layerName: 'layer_Daado_9',
            pane: 'pane_Daado_9',
            onEachFeature: pop_Daado_9,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.marker(latlng, style_Daado_9_0(feature));
            },
        });
        bounds_group.addLayer(layer_Daado_9);
        map.addLayer(layer_Daado_9);
        function pop_Bueno_10(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">fid</th>\
                        <td class="visible-with-data" id="fid">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Id</th>\
                        <td class="visible-with-data" id="Id">' + (feature.properties['Id'] !== null ? autolinker.link(String(feature.properties['Id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Tipo</th>\
                        <td class="visible-with-data" id="Tipo">' + (feature.properties['Tipo'] !== null ? autolinker.link(String(feature.properties['Tipo']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Estado</th>\
                        <td class="visible-with-data" id="Estado">' + (feature.properties['Estado'] !== null ? autolinker.link(String(feature.properties['Estado']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Foto_evidencia</th>\
                        <td class="visible-with-data" id="Foto_evidencia">' + (feature.properties['Foto_evidencia'] !== null ? '<img src="images/' + String(feature.properties['Foto_evidencia']).replace(/[\\/:]/g, '_').trim().replace(/'/g, '\'').replace(/"/g, '&quot;') + '">' : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Observaciones</th>\
                        <td id="Observaciones">' + ((feature.properties['Observaciones'] !== null && feature.properties['Observaciones'] !== "") ? autolinker.link(String(feature.properties['Observaciones']).replace(/'/g, '\'').toLocaleString()) : 'ninguno') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Bueno_10_0(feature) {
            switch(String(feature.properties['Estado'])) {
                case 'Bueno':
                    return {
                pane: 'pane_Bueno_10',
        rotationAngle: 0.0,
        rotationOrigin: 'center center',
        icon: L.icon({
            iconUrl: 'markers/Bueno_10.svg',
            iconSize: [22.799999999999997, 22.799999999999997]
        }),
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_Bueno_10');
        map.getPane('pane_Bueno_10').style.zIndex = 410;
        map.getPane('pane_Bueno_10').style['mix-blend-mode'] = 'normal';
        var layer_Bueno_10 = new L.geoJson(json_Bueno_10, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Bueno_10',
            layerName: 'layer_Bueno_10',
            pane: 'pane_Bueno_10',
            onEachFeature: pop_Bueno_10,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.marker(latlng, style_Bueno_10_0(feature));
            },
        });
        bounds_group.addLayer(layer_Bueno_10);
        map.addLayer(layer_Bueno_10);
        function pop_Apagada_11(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Id</th>\
                        <td class="visible-with-data" id="Id">' + (feature.properties['Id'] !== null ? autolinker.link(String(feature.properties['Id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Tipo</th>\
                        <td class="visible-with-data" id="Tipo">' + (feature.properties['Tipo'] !== null ? autolinker.link(String(feature.properties['Tipo']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Estado</th>\
                        <td class="visible-with-data" id="Estado">' + (feature.properties['Estado'] !== null ? autolinker.link(String(feature.properties['Estado']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Foto_evidencia</th>\
                        <td class="visible-with-data" id="Foto_evidencia">' + (feature.properties['Foto_evidencia'] !== null ? '<img src="images/' + String(feature.properties['Foto_evidencia']).replace(/[\\/:]/g, '_').trim().replace(/'/g, '\'').replace(/"/g, '&quot;') + '">' : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Observaciones</th>\
                        <td id="Observaciones">' + ((feature.properties['Observaciones'] !== null && feature.properties['Observaciones'] !== "") ? autolinker.link(String(feature.properties['Observaciones']).replace(/'/g, '\'').toLocaleString()) : 'ninguno') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Apagada_11_0(feature) {
            switch(String(feature.properties['Estado'])) {
                case 'Apagada':
                    return {
                pane: 'pane_Apagada_11',
        rotationAngle: 0.0,
        rotationOrigin: 'center center',
        icon: L.icon({
            iconUrl: 'markers/Apagada_11.svg',
            iconSize: [22.799999999999997, 22.799999999999997]
        }),
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_Apagada_11');
        map.getPane('pane_Apagada_11').style.zIndex = 411;
        map.getPane('pane_Apagada_11').style['mix-blend-mode'] = 'normal';
        var layer_Apagada_11 = new L.geoJson(json_Apagada_11, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Apagada_11',
            layerName: 'layer_Apagada_11',
            pane: 'pane_Apagada_11',
            onEachFeature: pop_Apagada_11,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.marker(latlng, style_Apagada_11_0(feature));
            },
        });
        bounds_group.addLayer(layer_Apagada_11);
        map.addLayer(layer_Apagada_11);
        function pop_Alumbradopostes_12(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Id'] !== null ? autolinker.link(String(feature.properties['Id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Tipo'] !== null ? autolinker.link(String(feature.properties['Tipo']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Estado'] !== null ? autolinker.link(String(feature.properties['Estado']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Foto_evidencia'] !== null ? '<img src="images/' + String(feature.properties['Foto_evidencia']).replace(/[\\/:]/g, '_').trim().replace(/'/g, '\'').replace(/"/g, '&quot;') + '">' : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Observaciones'] !== null ? autolinker.link(String(feature.properties['Observaciones']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Cuenta'] !== null ? autolinker.link(String(feature.properties['Cuenta']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Alumbradopostes_12_0(feature) {
            return {
                pane: 'pane_Alumbradopostes_12',
                rotationAngle: 0.0,
                rotationOrigin: 'center center',
                icon: L.icon({
                    iconUrl: 'markers/Alumbradopostes_12.svg',
                    iconSize: [0, 0]
                }),
                interactive: false,
            }
        }
        map.createPane('pane_Alumbradopostes_12');
        map.getPane('pane_Alumbradopostes_12').style.zIndex = 412;
        map.getPane('pane_Alumbradopostes_12').style['mix-blend-mode'] = 'normal';
        var layer_Alumbradopostes_12 = new L.geoJson(json_Alumbradopostes_12, {
            attribution: '',
            interactive: false,
            dataVar: 'json_Alumbradopostes_12',
            layerName: 'layer_Alumbradopostes_12',
            pane: 'pane_Alumbradopostes_12',
            onEachFeature: pop_Alumbradopostes_12,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.marker(latlng, style_Alumbradopostes_12_0(feature));
            },
        });
        bounds_group.addLayer(layer_Alumbradopostes_12);
        // --- INICIO DEL C√ìDIGO NUEVO (SISTEMA CL√ÅSICO) ---
        
        var baseMaps = {
            "OpenStreetMap": layer_OpenStreetMap_0,
            "Google Maps": layer_GoogleMaps_1,
            "Google Sat√©lite": layer_GoogleMapSatellite_2,
            "Google H√≠brido": layer_GoogleSatelliteHybrid_3
        };

        // --- C√ìDIGO DE √ÅRBOL CORREGIDO (CON GRUPOS) ---

        var overlaysTree = [
            {label: "üó∫Ô∏è Google H√≠brido", layer: layer_GoogleSatelliteHybrid_3, radioGroup: 'bm' },
            {label: "üó∫Ô∏è Google Sat√©lite", layer: layer_GoogleMapSatellite_2, radioGroup: 'bm' },
            {label: "üó∫Ô∏è Google Maps", layer: layer_GoogleMaps_1, radioGroup: 'bm' },
            {label: "üó∫Ô∏è OpenStreetMap", layer: layer_OpenStreetMap_0, radioGroup: 'bm' },
            // 1. GRUPO ESTADOS (Con todos tus filtros)
            {
                label: '<b>Estados</b>',
                selectAllCheckbox: true,
                collapsed: false, // ¬°ESTO HACE QUE SALGA ABIERTO!
                children: [
                    {label: '‚ö´ Apagada', layer: layer_Apagada_11},
                    {label: 'üü¢ Operativo (Bueno)', layer: layer_Bueno_10},
                    {label: 'üî¥ Da√±ado', layer: layer_Daado_9},
                    {label: 'üü° Directa', layer: layer_Directa_8},
                    {label: 'üü£ Intermitente', layer: layer_Intermitente_7},
                    {label: 'üü† Otro', layer: layer_Otro_6},
                ]
            },
            // 2. GRUPO ORTOFOTOS
            {
                label: '<b>Ortofoto</b>',
                selectAllCheckbox: true,
                collapsed: false,
                children: [
                    {label: "Ortofoto Parte 1", layer: layer_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5},
                    {label: "Ortofoto Parte 2", layer: layer_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4},
                ]
            },
            
        ];
        
        // ---MEN√ö DE CAPAS---
        var isMobile = window.innerWidth < 768;

        var lay = L.control.layers.tree(null, overlaysTree, {
            namedToggle: false,
            selectorBack: false,
            
            collapsed: isMobile, 
        });
        
        lay.addTo(map);
        
        setBounds();
        var i = 0;
        layer_Otro_6.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Id'] !== null?String('<div style="color: #000000; font-size: 10pt; font-weight: bold; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['Id']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Otro_6'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        var i = 0;
        layer_Intermitente_7.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Id'] !== null?String('<div style="color: #000000; font-size: 10pt; font-weight: bold; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['Id']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Intermitente_7'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        var i = 0;
        layer_Directa_8.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Id'] !== null?String('<div style="color: #000000; font-size: 10pt; font-weight: bold; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['Id']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Directa_8'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        var i = 0;
        layer_Daado_9.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Id'] !== null?String('<div style="color: #000000; font-size: 10pt; font-weight: bold; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['Id']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Daado_9'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        var i = 0;
        layer_Bueno_10.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Id'] !== null?String('<div style="color: #000000; font-size: 10pt; font-weight: bold; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['Id']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Bueno_10'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        var i = 0;
        layer_Apagada_11.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Id'] !== null?String('<div style="color: #000000; font-size: 10pt; font-weight: bold; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['Id']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Apagada_11'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        
        map.addControl(new L.Control.Search({
            layer: layer_Alumbradopostes_12,
            initial: false,
            hideMarkerOnCollapse: true,
            propertyName: 'Id'}));
        if (typeof url === 'undefined') {
            document.getElementsByClassName('search-button')[0].className += ' fa fa-binoculars';
        } else {
            document.getElementsByClassName('search-button')[1].className += ' fa fa-binoculars';
        }
        L.ImageOverlay.include({
            getBounds: function () {
                return this._bounds;
            }
        });
        resetLabels([layer_Otro_6,layer_Intermitente_7,layer_Directa_8,layer_Daado_9,layer_Bueno_10,layer_Apagada_11]);
        map.on("zoomend", function(){
            resetLabels([layer_Otro_6,layer_Intermitente_7,layer_Directa_8,layer_Daado_9,layer_Bueno_10,layer_Apagada_11]);
        });
        map.on("layeradd", function(){
            resetLabels([layer_Otro_6,layer_Intermitente_7,layer_Directa_8,layer_Daado_9,layer_Bueno_10,layer_Apagada_11]);
        });
        map.on("layerremove", function(){
            resetLabels([layer_Otro_6,layer_Intermitente_7,layer_Directa_8,layer_Daado_9,layer_Bueno_10,layer_Apagada_11]);
        });
        
        </script>    
        
        <div id="image-modal" class="modal-overlay" onclick="closeModal()">
  <span class="close-modal">&times;</span>
  <img class="modal-content" id="full-image">
</div>
    
    <script>
        // 1. Funci√≥n para CERRAR el visor (la llama el onclick del HTML)
        function closeModal() {
            document.getElementById("image-modal").style.display = "none";
        }

        // 2. DETECTOR DE CLICS "A PRUEBA DE FALLOS"
        // Este c√≥digo vigila cualquier clic que hagas en la pantalla
        document.addEventListener('click', function(e) {
            
            // ¬øLe diste clic a una IMAGEN (IMG) que est√° dentro de un POPUP?
            if (e.target && e.target.tagName === 'IMG' && e.target.closest('.leaflet-popup-content')) {
                
                // ¬°S√ç! Entonces detenemos lo que sea que iba a hacer el navegador
                e.preventDefault();
                e.stopPropagation();

                // Buscamos tu caja negra y la imagen gigante
                var modal = document.getElementById("image-modal");
                var modalImg = document.getElementById("full-image");
                
                // La mostramos en pantalla
                modal.style.display = "flex";
                modal.style.alignItems = "center";
                modal.style.justifyContent = "center";
                
                // Le pasamos la foto que tocaste para que se vea grande
                modalImg.src = e.target.src;
            }
        });
    </script>


    <div id="chart-modal" class="modal-overlay" onclick="closeChart()">
    <div class="chart-card-drobot" onclick="event.stopPropagation()">
        <div class="chart-header-drobot">
            <span class="chart-title"><i class="fas fa-chart-pie"></i> Diagn√≥stico Estad√≠stico</span>
            <span class="close-chart-btn" onclick="closeChart()">&times;</span>
        </div>
        
        <div class="chart-body-drobot">
            <canvas id="drobotChart"></canvas>
        </div>
        
        <div class="chart-controls-drobot">
            <button class="chart-btn active" onclick="updateChartType('bar', this)" title="Barras">
                <i class="fas fa-chart-bar"></i> Barras
            </button>
            <button class="chart-btn" onclick="updateChartType('doughnut', this)" title="Dona">
                 <i class="fas fa-circle-notch"></i> Dona
            </button>
            <button class="chart-btn" onclick="updateChartType('pie', this)" title="Pastel">
                <i class="fas fa-chart-pie"></i> Pastel
            </button>
             <button class="chart-btn" onclick="updateChartType('line', this)" title="Tendencia">
                <i class="fas fa-chart-line"></i> L√≠nea
            </button>
        </div>
    </div>
</div>


    <style>
    /* --- ESTILOS DEL DASHBOARD DROBOT --- */
    .chart-card-drobot {
        background: white;
        border-radius: 16px; /* Bordes m√°s suaves */
        width: 95%;
        max-width: 700px; /* Un poco m√°s ancho */
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        overflow: hidden; /* Para que el header azul no se salga de las esquinas */
        display: flex;
        flex-direction: column;
        animation: slideUp 0.4s ease;
    }

    /* 1. Header Azul */
    .chart-header-drobot {
        background: linear-gradient(90deg, #0b1c2c 0%, #1a2e40 100%); /* Mismo azul que la barra principal */
        color: white;
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .chart-title { font-weight: 700; font-size: 18px; letter-spacing: 0.5px; }
    .close-chart-btn { font-size: 28px; cursor: pointer; color: rgba(255,255,255,0.8); transition: 0.2s; }
    .close-chart-btn:hover { color: white; }

    /* 2. Cuerpo */
    .chart-body-drobot {
        padding: 25px;
        height: 350px; /* Altura fija para la gr√°fica */
        position: relative;
    }

    /* 3. Controles (Botones inferiores) */
    .chart-controls-drobot {
        padding: 15px 25px;
        background: #f8f9fa; /* Gris muy clarito */
        border-top: 1px solid #eee;
        display: flex;
        justify-content: center;
        gap: 10px; /* Espacio entre botones */
    }
    .chart-btn {
        background: white;
        border: 1px solid #ddd;
        padding: 10px 20px;
        border-radius: 30px; /* Botones tipo pastilla */
        cursor: pointer;
        font-family: 'Montserrat', sans-serif;
        font-weight: 600;
        color: #555;
        transition: all 0.3s ease;
        display: flex; align-items: center; gap: 8px;
    }
    .chart-btn i { font-size: 16px; }
    
    /* Estado Activo y Hover */
    .chart-btn:hover { background: #f0f0f0; transform: translateY(-2px); }
    .chart-btn.active {
        background: #0b1c2c; /* Azul Drobot cuando est√° seleccionado */
        color: white;
        border-color: #0b1c2c;
        box-shadow: 0 4px 10px rgba(11, 28, 44, 0.3);
    }
    @keyframes slideUp { from {transform:translateY(50px); opacity:0} to {transform:translateY(0); opacity:1} }
</style>

<script>
    // --- 1. BOT√ìN EN EL MAPA (Igual que antes) ---
    L.Control.Graph = L.Control.extend({
        onAdd: function(map) {
            // Usamos el icono de pastel de FontAwesome para que se vea pro
            var div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            div.innerHTML = '<a href="#" title="Ver Dashboard" role="button" onclick="openChart(event)" style="display:flex; align-items:center; justify-content:center;"><i class="fas fa-chart-pie" style="font-size:20px;"></i></a>';
            return div;
        }
    });
    new L.Control.Graph({ position: 'topleft' }).addTo(map);

    // --- 2. L√ìGICA AVANZADA DE GR√ÅFICAS ---
    var myChart; // Variable global para la instancia de la gr√°fica
    // Variables globales para los datos (para no recalcularlos siempre)
    var globalData = [];
    var globalLabels = ['Apagada', 'Operativo', 'Da√±ado', 'Directa', 'Intermitente', 'Otro'];
    var globalColors = ['#333333', '#2ecc71', '#e74c3c', '#f1c40f', '#9b59b6', '#e67e22'];

    // Funci√≥n para abrir el modal y cargar datos por primera vez
    function openChart(e) {
        if(e) e.preventDefault();
        document.getElementById("chart-modal").style.display = "flex";
        document.getElementById("chart-modal").style.alignItems = "center";
        document.getElementById("chart-modal").style.justifyContent = "center";

        // Si ya calculamos los datos, solo actualizamos el tipo a Barras por defecto
        if (globalData.length > 0) {
             // Reseteamos botones visualmente
             resetButtons();
             document.querySelector('.chart-btn[onclick*="bar"]').classList.add('active');
             updateChartType('bar', null); // null porque ya activamos el bot√≥n manualmente
             return;
        }

        // --- CONTAR DATOS UNA SOLA VEZ ---
        globalData = [
            json_Apagada_11.features.length,
            json_Bueno_10.features.length,
            json_Daado_9.features.length,
            json_Directa_8.features.length,
            json_Intermitente_7.features.length,
            json_Otro_6.features.length
        ];

        // Crear la primera gr√°fica (Barras por defecto)
        createChart('bar');
    }

    // Funci√≥n para CERRAR
    function closeChart() {
        document.getElementById("chart-modal").style.display = "none";
    }

    // --- FUNCI√ìN CLAVE: CAMBIAR EL TIPO DE GR√ÅFICA ---
    function updateChartType(newType, btnElement) {
        // 1. Manejo visual de los botones (si se hizo clic en uno)
        if (btnElement) {
            resetButtons();
            btnElement.classList.add('active'); // Activar el bot√≥n clickeado
        }

        // 2. Destruir la gr√°fica anterior si existe (OBLIGATORIO en Chart.js)
        if (myChart) {
            myChart.destroy();
        }

        // 3. Crear la nueva gr√°fica con el nuevo tipo
        createChart(newType);
    }

    // Funci√≥n auxiliar para resetear estilo de botones
    function resetButtons() {
         var btns = document.querySelectorAll('.chart-btn');
         btns.forEach(btn => btn.classList.remove('active'));
    }

    // Funci√≥n auxiliar para crear la instancia de Chart.js
    function createChart(type) {
        var ctx = document.getElementById('drobotChart').getContext('2d');
        
        // Configuraci√≥n base
        var config = {
            type: type,
            data: {
                labels: globalLabels,
                datasets: [{
                    label: 'Cantidad',
                    data: globalData,
                    backgroundColor: globalColors,
                    borderWidth: 2,
                    borderColor: '#ffffff',
                    borderRadius: type === 'bar' ? 8 : 0, // Redondear solo si es barras
                    hoverOffset: 10 // Efecto al pasar el mouse en pastel/dona
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: type !== 'bar' && type !== 'line', // Mostrar leyenda solo en pastel/dona
                        position: 'bottom',
                         labels: { font: { family: 'Montserrat', size: 12 } }
                    },
                    tooltip: {
                        backgroundColor: '#0b1c2c',
                        titleFont: { family: 'Montserrat' },
                        bodyFont: { family: 'Montserrat' }
                    }
                },
                scales: {
                    // Ocultar ejes X/Y si es pastel o dona, mostrarlos si es barra o l√≠nea
                    x: { display: type === 'bar' || type === 'line' },
                    y: { display: type === 'bar' || type === 'line', beginAtZero: true }
                },
                 elements: {
                    line: { tension: 0.4 } // Hacer las l√≠neas curvas (suaves)
                }
            }
        };

        myChart = new Chart(ctx, config);
    }
</script>

    </body>
</html>
