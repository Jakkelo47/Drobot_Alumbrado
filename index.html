<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>

        /* Estilo para las etiquetas de AGEB */
    .leaflet-tooltip.label-ageb {
        background: transparent;
        border: none;
        box-shadow: none;
    }
    /* --- 1. EL CANDADO UNIVERSAL (NUEVO) --- */
    * {
        box-sizing: border-box; /* Esto arregla el error de matemáticas */
    }

    /* --- 2. ELIMINAR REBOTE (NUEVO) --- */
    html, body { 
        margin: 0; 
        padding: 0; 
        width: 100%; 
        height: 100%; 
        overflow: hidden; 
        overscroll-behavior: none; /* Esto evita que "reboten" en iPhone/Android */
    }
        /* --- FUENTE OFICIAL --- */
        body, .leaflet-container, .drobot-title {
            font-family: 'Montserrat', sans-serif !important;
        }
        
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }

        #map {
    width: 100%;
    
    height: calc(100vh - 80px) !important; 
    margin-top: 0;
    background-color: #f0f0f0;
}

        /* --- 1. BARRA SUPERIOR (TU PALETA EXACTA) --- */
        #top-bar {
            height: 80px;
            /* TU COLOR 1: Guinda Oscuro #7E1928 */
            background: #7E1928; 
            /* TU COLOR 2: Dorado #C3935D */
            border-bottom: 4px solid #C3935D; 
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 3000;
            position: relative;
        }

        .logo-area {
            display: flex;
            align-items: center; 
            height: 100%;
        }

        #drobot-logo { 
            height: 45px;
            width: auto;
            margin-right: 15px; 
            display: block; 
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
        }

        .drobot-title { 
            font-weight: 700; 
            font-size: 18px;
            letter-spacing: 0.5px;
            line-height: 1.2;
            text-transform: uppercase;
        }

        .client-area { 
            font-size: 13px; 
            color: rgba(255,255,255,0.9); 
            /* TU COLOR 2: Dorado */
            border-left: 1px solid #C3935D; 
            padding-left: 20px; 
            font-weight: 600;
            height: 40px;
            display: flex;
            align-items: center;
        }

        /* --- 2. CONTROLES DEL MAPA --- */
        .leaflet-bar {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            border: none !important;
            border-radius: 8px !important;
            overflow: hidden;
        }

        .leaflet-bar a, 
        .leaflet-control-layers-toggle {
            background-color: white !important;
            color: #444 !important;
            width: 36px !important;
            height: 36px !important;
            line-height: 36px !important;
            font-weight: bold !important;
            border-bottom: 1px solid #f0f0f0 !important;
            transition: all 0.2s ease;
        }

        /* Hover con TU COLOR 3 (Rojo Vivo #A21131) */
        .leaflet-bar a:hover {
            background-color: #f8f9fa !important;
            color: #A21131 !important; 
            border-left: 3px solid #C3935D !important;
        }

        /* --- 3. MENÚ DE CAPAS --- */
        .leaflet-control-layers {
            border: none !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15) !important;
            padding: 15px !important;
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(5px);
        }

        .leaflet-control-layers-group-label {
            color: #7E1928; /* Guinda Oscuro */
            font-weight: 700;
            font-size: 14px;
            margin-top: 8px;
            display: block;
            border-bottom: 2px solid #C3935D; /* Dorado */
            padding-bottom: 4px;
            margin-bottom: 8px;
        }

        .leaflet-control-layers label {
            margin-bottom: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .leaflet-control-layers label:hover {
            color: #A21131; /* Rojo Vivo al pasar mouse */
        }

        /* --- 4. POPUPS --- */
        .leaflet-popup-content-wrapper {
            border-radius: 12px !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2) !important;
            padding: 0 !important;
            overflow: hidden;
        }
        
        .leaflet-popup-content {
            margin: 15px !important;
            line-height: 1.6;
            font-size: 13px;
        }
        
        .leaflet-popup-content h3 {
            background: #7E1928; /* Guinda Oscuro */
            border-bottom: 3px solid #C3935D; /* Dorado */
            color: white;
            margin: -15px -15px 10px -15px;
            padding: 10px 15px;
            font-size: 14px;
            text-transform: uppercase;
        }

        /* --- 5. UTILIDADES --- */
        .leaflet-top { top: 20px; }
        .leaflet-left { left: 20px; }
        .leaflet-right { right: 20px; }
        .css_Alumbradopostes_12 { display: none !important; }

        /* --- 6. TABLA POPUP --- */
        .leaflet-popup-content table tr:first-child { display: none !important; }
        .leaflet-popup-content table {
            width: 100% !important; border-collapse: separate !important;
            border-spacing: 0 8px !important; font-size: 14px !important; margin: 10px 0 !important;
        }
        .leaflet-popup-content th {
            text-align: left !important; color: #666 !important; font-weight: 500 !important;
            vertical-align: top !important; width: 30% !important; padding-right: 5px !important;
        }
        .leaflet-popup-content td {
            text-align: left !important; color: #333 !important;
            font-weight: 700 !important;
            vertical-align: top !important; width: 70% !important; word-break: break-word !important;
        }

        /* --- 7. MINIATURAS Y VISOR --- */
        .leaflet-popup-content td img, .leaflet-popup-content td a img {
            display: block !important; width: 100% !important; max-width: 300px !important;
            height: 200px !important;
            object-fit: cover !important;
            border-radius: 12px !important;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2) !important;
            margin-top: 10px !important;
            cursor: zoom-in !important;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .leaflet-popup-content td img:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3) !important;
        }
        .modal-overlay {
            display: none;
            position: fixed; z-index: 99999;
            padding-top: 50px; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.92);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            margin: auto; display: block; width: auto; height: auto;
            max-width: 90vw; max-height: 85vh;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: zoom 0.4s;
        }
        .close-modal {
            position: absolute; top: 20px; right: 35px; color: #f1f1f1;
            font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer;
        }
        .close-modal:hover, .close-modal:focus { color: #bbb; text-decoration: none; cursor: pointer; }
        @keyframes zoom { from {transform:scale(0.8); opacity:0} to {transform:scale(1); opacity:1} }
        .leaflet-popup-content { min-width: 320px !important; }
        .leaflet-popup-content-wrapper { border-radius: 16px !important; }

        /* --- 8. DASHBOARD (Colores Nuevos) --- */
        .chart-card-drobot {
            background: white;
            border-radius: 16px;
            width: 95%; max-width: 700px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            display: flex; flex-direction: column;
            animation: slideUp 0.4s ease;
        }
        .chart-header-drobot {
            background: #7E1928 !important; /* Guinda Oscuro */
            border-bottom: 3px solid #C3935D !important; /* Dorado */
            color: white;
            padding: 15px 25px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .chart-title { font-weight: 700; font-size: 18px; letter-spacing: 0.5px; }
        .close-chart-btn { font-size: 28px; cursor: pointer; color: rgba(255,255,255,0.8); transition: 0.2s; }
        .close-chart-btn:hover { color: white; }
        .chart-body-drobot { padding: 25px; height: 350px; position: relative; }
        .chart-controls-drobot {
            padding: 15px 25px; background: #f8f9fa; border-top: 1px solid #eee;
            display: flex; justify-content: center; gap: 10px;
        }
        .chart-btn {
            background: white; border: 1px solid #ddd; padding: 10px 20px;
            border-radius: 30px; cursor: pointer;
            font-family: 'Montserrat', sans-serif; font-weight: 600; color: #555;
            transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;
        }
        .chart-btn:hover { background: #f0f0f0; transform: translateY(-2px); }
        .chart-btn.active {
            background: #7E1928; /* Guinda Activo */
            color: white; border-color: #7E1928;
            box-shadow: 0 4px 10px rgba(126, 25, 40, 0.3);
        }
        @keyframes slideUp { from {transform:translateY(50px); opacity:0} to {transform:translateY(0); opacity:1} }
    </style>
        <title></title>
    </head>
    <body>
    <div id="top-bar"> <div class="logo-area">
            <div class="logo-box">
                <img src="Martínez_logo.jpeg" alt="Escudo" id="drobot-logo">
            </div>
            
            <div style="display:flex; flex-direction:column; justify-content:center;">
                <span class="drobot-title" style="font-size:16px;">H. AYUNTAMIENTO</span>
                <span style="font-size:11px; font-weight:400; text-transform:uppercase; letter-spacing:1px;">Martínez de la Torre | 2026-2029</span>
            </div>
        </div>
        <div class="client-area">
            <span>CATASTRO Y DESARROLLO URBANO</span>
        </div>

    </div> <div id="map">
    </div>
        <script src="data/AGEB_7.js"></script>
        <script src="data/Vialidades_6.js"></script>
        <script src="data/Manzanas_4.js"></script>
        <script src="data/Limitemunicipal_5.js"></script>
        <script src="js/leaflet-side-by-side.js"></script>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="data/Otro_6.js"></script>
        <script src="data/Intermitente_7.js"></script>
        <script src="data/Directa_8.js"></script>
        <script src="data/Daado_9.js"></script>
        <script src="data/Bueno_10.js"></script>
        <script src="data/Apagada_11.js"></script>
        <script src="data/Alumbradopostes_12.js"></script>
        <script>
        var highlightLayer;
        function highlightFeature(e) {
            highlightLayer = e.target;

            if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
              highlightLayer.setStyle({
                color: '#ffff00',
              });
            } else {
              highlightLayer.setStyle({
                fillColor: '#ffff00',
                fillOpacity: 1
              });
            }
        }
        var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:1
        }).setView([20.0605, -97.0555], 14); // <--- AQUÍ FORZAMOS MARTÍNEZ DE LA TORRE
        //var hash = new L.Hash(map);
        var dibujanteCompartido = L.canvas({ padding: 0.5 , tolerance: 15});
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.update();
                    }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video');
                    video.controls = true;
                    video.src = src;
                    video.style.width = "400px";
                    video.style.height = "300px";
                    video.style.maxHeight = "60vh";
                    video.style.maxWidth = "60vw";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    video.addEventListener('loadedmetadata', function() {
                        popup.update();
                    });
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            } else {
                popup._contentNode.classList.remove('media');
            }
        }
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares'
        });
        measureControl.addTo(map);
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
            if (bounds_group.getLayers().length) {
                map.fitBounds(bounds_group.getBounds());
            }
        }
        map.createPane('pane_OpenStreetMap_0');
        map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
        var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OpenStreetMap_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_OpenStreetMap_0;
        
        map.createPane('pane_GoogleMaps_1');
        map.getPane('pane_GoogleMaps_1').style.zIndex = 401;
        var layer_GoogleMaps_1 = L.tileLayer('https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}', {
            pane: 'pane_GoogleMaps_1',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_GoogleMaps_1;
        
        map.createPane('pane_GoogleMapSatellite_2');
        map.getPane('pane_GoogleMapSatellite_2').style.zIndex = 402;
        var layer_GoogleMapSatellite_2 = L.tileLayer('http://www.google.cn/maps/vt?lyrs=s@189&gl=cn&x={x}&y={y}&z={z}', {
            pane: 'pane_GoogleMapSatellite_2',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_GoogleMapSatellite_2;
        map.addLayer(layer_GoogleMapSatellite_2);
        map.createPane('pane_GoogleSatelliteHybrid_3');
        map.getPane('pane_GoogleSatelliteHybrid_3').style.zIndex = 403;
        var layer_GoogleSatelliteHybrid_3 = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            pane: 'pane_GoogleSatelliteHybrid_3',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_GoogleSatelliteHybrid_3;
        
        map.createPane('pane_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4');
        map.getPane('pane_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4').style.zIndex = 404;
        var img_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4 = 'data/dji_fly_20250722_185244_0181_1769184310403_photo_modified_4.webp';
        var img_bounds_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4 = [[20.477305525524667,-97.44742707624859],[20.477688255136947,-97.44690449256086]];
        var layer_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4 = new L.imageOverlay(img_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4,
                                              img_bounds_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4,
                                              {pane: 'pane_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4'});
        bounds_group.addLayer(layer_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4);
        map.addLayer(layer_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4);
        map.createPane('pane_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5');
        map.getPane('pane_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5').style.zIndex = 405;
        var img_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5 = 'data/dji_fly_20250722_185256_0182_1769184314666_photo_modified_5.webp';
        var img_bounds_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5 = [[20.47713020129182,-97.44748035804977],[20.47751380984635,-97.44692639028311]];
        var layer_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5 = new L.imageOverlay(img_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5,
                                              img_bounds_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5,
                                              {pane: 'pane_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5'});
        bounds_group.addLayer(layer_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5);
        map.addLayer(layer_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5);
        function pop_Otro_6(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Id</th>\
                        <td class="visible-with-data" id="Id">' + (feature.properties['Id'] !== null ? autolinker.link(String(feature.properties['Id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Tipo</th>\
                        <td class="visible-with-data" id="Tipo">' + (feature.properties['Tipo'] !== null ? autolinker.link(String(feature.properties['Tipo']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Estado</th>\
                        <td class="visible-with-data" id="Estado">' + (feature.properties['Estado'] !== null ? autolinker.link(String(feature.properties['Estado']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Foto_evidencia</th>\
                        <td class="visible-with-data" id="Foto_evidencia">' + (feature.properties['Foto_evidencia'] !== null ? '<img src="images/' + String(feature.properties['Foto_evidencia']).replace(/[\\/:]/g, '_').trim().replace(/'/g, '\'').replace(/"/g, '&quot;') + '">' : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Observaciones</th>\
                        <td id="Observaciones">' + ((feature.properties['Observaciones'] !== null && feature.properties['Observaciones'] !== "") ? autolinker.link(String(feature.properties['Observaciones']).replace(/'/g, '\'').toLocaleString()) : 'ninguno') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Otro_6_0(feature) {
            switch(String(feature.properties['Estado'])) {
                case 'Otro':
                    return {
                pane: 'pane_Otro_6',
        rotationAngle: 0.0,
        rotationOrigin: 'center center',
        icon: L.icon({
            iconUrl: 'markers/Otro_6.svg',
            iconSize: [22.799999999999997, 22.799999999999997]
        }),
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_Otro_6');
        map.getPane('pane_Otro_6').style.zIndex = 406;
        map.getPane('pane_Otro_6').style['mix-blend-mode'] = 'normal';
        var layer_Otro_6 = new L.geoJson(json_Otro_6, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Otro_6',
            layerName: 'layer_Otro_6',
            pane: 'pane_Otro_6',
            onEachFeature: pop_Otro_6,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.marker(latlng, style_Otro_6_0(feature));
            },
        });
        bounds_group.addLayer(layer_Otro_6);
        map.addLayer(layer_Otro_6);
        function pop_Intermitente_7(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Id</th>\
                        <td class="visible-with-data" id="Id">' + (feature.properties['Id'] !== null ? autolinker.link(String(feature.properties['Id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Tipo</th>\
                        <td class="visible-with-data" id="Tipo">' + (feature.properties['Tipo'] !== null ? autolinker.link(String(feature.properties['Tipo']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Estado</th>\
                        <td class="visible-with-data" id="Estado">' + (feature.properties['Estado'] !== null ? autolinker.link(String(feature.properties['Estado']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Foto_evidencia</th>\
                        <td class="visible-with-data" id="Foto_evidencia">' + (feature.properties['Foto_evidencia'] !== null ? '<img src="images/' + String(feature.properties['Foto_evidencia']).replace(/[\\/:]/g, '_').trim().replace(/'/g, '\'').replace(/"/g, '&quot;') + '">' : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Observaciones</th>\
                        <td id="Observaciones">' + ((feature.properties['Observaciones'] !== null && feature.properties['Observaciones'] !== "") ? autolinker.link(String(feature.properties['Observaciones']).replace(/'/g, '\'').toLocaleString()) : 'ninguno') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Intermitente_7_0(feature) {
            switch(String(feature.properties['Estado'])) {
                case 'Intermitente':
                    return {
                pane: 'pane_Intermitente_7',
        rotationAngle: 0.0,
        rotationOrigin: 'center center',
        icon: L.icon({
            iconUrl: 'markers/Intermitente_7.svg',
            iconSize: [22.799999999999997, 22.799999999999997]
        }),
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_Intermitente_7');
        map.getPane('pane_Intermitente_7').style.zIndex = 407;
        map.getPane('pane_Intermitente_7').style['mix-blend-mode'] = 'normal';
        var layer_Intermitente_7 = new L.geoJson(json_Intermitente_7, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Intermitente_7',
            layerName: 'layer_Intermitente_7',
            pane: 'pane_Intermitente_7',
            onEachFeature: pop_Intermitente_7,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.marker(latlng, style_Intermitente_7_0(feature));
            },
        });
        bounds_group.addLayer(layer_Intermitente_7);
        map.addLayer(layer_Intermitente_7);
        function pop_Directa_8(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Id</th>\
                        <td class="visible-with-data" id="Id">' + (feature.properties['Id'] !== null ? autolinker.link(String(feature.properties['Id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Tipo</th>\
                        <td class="visible-with-data" id="Tipo">' + (feature.properties['Tipo'] !== null ? autolinker.link(String(feature.properties['Tipo']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Estado</th>\
                        <td class="visible-with-data" id="Estado">' + (feature.properties['Estado'] !== null ? autolinker.link(String(feature.properties['Estado']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Foto_evidencia</th>\
                        <td class="visible-with-data" id="Foto_evidencia">' + (feature.properties['Foto_evidencia'] !== null ? '<img src="images/' + String(feature.properties['Foto_evidencia']).replace(/[\\/:]/g, '_').trim().replace(/'/g, '\'').replace(/"/g, '&quot;') + '">' : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Observaciones</th>\
                        <td id="Observaciones">' + ((feature.properties['Observaciones'] !== null && feature.properties['Observaciones'] !== "") ? autolinker.link(String(feature.properties['Observaciones']).replace(/'/g, '\'').toLocaleString()) : 'ninguno') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Directa_8_0(feature) {
            switch(String(feature.properties['Estado'])) {
                case 'Directa':
                    return {
                pane: 'pane_Directa_8',
        rotationAngle: 0.0,
        rotationOrigin: 'center center',
        icon: L.icon({
            iconUrl: 'markers/Directa_8.svg',
            iconSize: [22.799999999999997, 22.799999999999997]
        }),
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_Directa_8');
        map.getPane('pane_Directa_8').style.zIndex = 408;
        map.getPane('pane_Directa_8').style['mix-blend-mode'] = 'normal';
        var layer_Directa_8 = new L.geoJson(json_Directa_8, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Directa_8',
            layerName: 'layer_Directa_8',
            pane: 'pane_Directa_8',
            onEachFeature: pop_Directa_8,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.marker(latlng, style_Directa_8_0(feature));
            },
        });
        bounds_group.addLayer(layer_Directa_8);
        map.addLayer(layer_Directa_8);
        function pop_Daado_9(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Id</th>\
                        <td class="visible-with-data" id="Id">' + (feature.properties['Id'] !== null ? autolinker.link(String(feature.properties['Id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Tipo</th>\
                        <td class="visible-with-data" id="Tipo">' + (feature.properties['Tipo'] !== null ? autolinker.link(String(feature.properties['Tipo']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Estado</th>\
                        <td class="visible-with-data" id="Estado">' + (feature.properties['Estado'] !== null ? autolinker.link(String(feature.properties['Estado']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Foto_evidencia</th>\
                        <td class="visible-with-data" id="Foto_evidencia">' + (feature.properties['Foto_evidencia'] !== null ? '<img src="images/' + String(feature.properties['Foto_evidencia']).replace(/[\\/:]/g, '_').trim().replace(/'/g, '\'').replace(/"/g, '&quot;') + '">' : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Observaciones</th>\
                        <td id="Observaciones">' + ((feature.properties['Observaciones'] !== null && feature.properties['Observaciones'] !== "") ? autolinker.link(String(feature.properties['Observaciones']).replace(/'/g, '\'').toLocaleString()) : 'ninguno') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Daado_9_0(feature) {
            switch(String(feature.properties['Estado'])) {
                case 'Dañado':
                    return {
                pane: 'pane_Daado_9',
        rotationAngle: 0.0,
        rotationOrigin: 'center center',
        icon: L.icon({
            iconUrl: 'markers/Daado_9.svg',
            iconSize: [22.799999999999997, 22.799999999999997]
        }),
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_Daado_9');
        map.getPane('pane_Daado_9').style.zIndex = 409;
        map.getPane('pane_Daado_9').style['mix-blend-mode'] = 'normal';
        var layer_Daado_9 = new L.geoJson(json_Daado_9, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Daado_9',
            layerName: 'layer_Daado_9',
            pane: 'pane_Daado_9',
            onEachFeature: pop_Daado_9,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.marker(latlng, style_Daado_9_0(feature));
            },
        });
        bounds_group.addLayer(layer_Daado_9);
        map.addLayer(layer_Daado_9);
        function pop_Bueno_10(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">fid</th>\
                        <td class="visible-with-data" id="fid">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Id</th>\
                        <td class="visible-with-data" id="Id">' + (feature.properties['Id'] !== null ? autolinker.link(String(feature.properties['Id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Tipo</th>\
                        <td class="visible-with-data" id="Tipo">' + (feature.properties['Tipo'] !== null ? autolinker.link(String(feature.properties['Tipo']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Estado</th>\
                        <td class="visible-with-data" id="Estado">' + (feature.properties['Estado'] !== null ? autolinker.link(String(feature.properties['Estado']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Foto_evidencia</th>\
                        <td class="visible-with-data" id="Foto_evidencia">' + (feature.properties['Foto_evidencia'] !== null ? '<img src="images/' + String(feature.properties['Foto_evidencia']).replace(/[\\/:]/g, '_').trim().replace(/'/g, '\'').replace(/"/g, '&quot;') + '">' : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Observaciones</th>\
                        <td id="Observaciones">' + ((feature.properties['Observaciones'] !== null && feature.properties['Observaciones'] !== "") ? autolinker.link(String(feature.properties['Observaciones']).replace(/'/g, '\'').toLocaleString()) : 'ninguno') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Bueno_10_0(feature) {
            switch(String(feature.properties['Estado'])) {
                case 'Bueno':
                    return {
                pane: 'pane_Bueno_10',
        rotationAngle: 0.0,
        rotationOrigin: 'center center',
        icon: L.icon({
            iconUrl: 'markers/Bueno_10.svg',
            iconSize: [22.799999999999997, 22.799999999999997]
        }),
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_Bueno_10');
        map.getPane('pane_Bueno_10').style.zIndex = 410;
        map.getPane('pane_Bueno_10').style['mix-blend-mode'] = 'normal';
        var layer_Bueno_10 = new L.geoJson(json_Bueno_10, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Bueno_10',
            layerName: 'layer_Bueno_10',
            pane: 'pane_Bueno_10',
            onEachFeature: pop_Bueno_10,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.marker(latlng, style_Bueno_10_0(feature));
            },
        });
        bounds_group.addLayer(layer_Bueno_10);
        map.addLayer(layer_Bueno_10);
        function pop_Apagada_11(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Id</th>\
                        <td class="visible-with-data" id="Id">' + (feature.properties['Id'] !== null ? autolinker.link(String(feature.properties['Id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Tipo</th>\
                        <td class="visible-with-data" id="Tipo">' + (feature.properties['Tipo'] !== null ? autolinker.link(String(feature.properties['Tipo']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Estado</th>\
                        <td class="visible-with-data" id="Estado">' + (feature.properties['Estado'] !== null ? autolinker.link(String(feature.properties['Estado']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Foto_evidencia</th>\
                        <td class="visible-with-data" id="Foto_evidencia">' + (feature.properties['Foto_evidencia'] !== null ? '<img src="images/' + String(feature.properties['Foto_evidencia']).replace(/[\\/:]/g, '_').trim().replace(/'/g, '\'').replace(/"/g, '&quot;') + '">' : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Observaciones</th>\
                        <td id="Observaciones">' + ((feature.properties['Observaciones'] !== null && feature.properties['Observaciones'] !== "") ? autolinker.link(String(feature.properties['Observaciones']).replace(/'/g, '\'').toLocaleString()) : 'ninguno') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Apagada_11_0(feature) {
            switch(String(feature.properties['Estado'])) {
                case 'Apagada':
                    return {
                pane: 'pane_Apagada_11',
        rotationAngle: 0.0,
        rotationOrigin: 'center center',
        icon: L.icon({
            iconUrl: 'markers/Apagada_11.svg',
            iconSize: [22.799999999999997, 22.799999999999997]
        }),
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_Apagada_11');
        map.getPane('pane_Apagada_11').style.zIndex = 411;
        map.getPane('pane_Apagada_11').style['mix-blend-mode'] = 'normal';
        var layer_Apagada_11 = new L.geoJson(json_Apagada_11, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Apagada_11',
            layerName: 'layer_Apagada_11',
            pane: 'pane_Apagada_11',
            onEachFeature: pop_Apagada_11,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.marker(latlng, style_Apagada_11_0(feature));
            },
        });
        bounds_group.addLayer(layer_Apagada_11);
        map.addLayer(layer_Apagada_11);
        function pop_Alumbradopostes_12(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Id'] !== null ? autolinker.link(String(feature.properties['Id']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Tipo'] !== null ? autolinker.link(String(feature.properties['Tipo']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Estado'] !== null ? autolinker.link(String(feature.properties['Estado']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Foto_evidencia'] !== null ? '<img src="images/' + String(feature.properties['Foto_evidencia']).replace(/[\\/:]/g, '_').trim().replace(/'/g, '\'').replace(/"/g, '&quot;') + '">' : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Observaciones'] !== null ? autolinker.link(String(feature.properties['Observaciones']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Cuenta'] !== null ? autolinker.link(String(feature.properties['Cuenta']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Alumbradopostes_12_0(feature) {
            return {
                pane: 'pane_Alumbradopostes_12',
                rotationAngle: 0.0,
                rotationOrigin: 'center center',
                icon: L.icon({
                    iconUrl: 'markers/Alumbradopostes_12.svg',
                    iconSize: [0, 0]
                }),
                interactive: false,
            }
        }
        map.createPane('pane_Alumbradopostes_12');
        map.getPane('pane_Alumbradopostes_12').style.zIndex = 412;
        map.getPane('pane_Alumbradopostes_12').style['mix-blend-mode'] = 'normal';
        var layer_Alumbradopostes_12 = new L.geoJson(json_Alumbradopostes_12, {
            attribution: '',
            interactive: false,
            dataVar: 'json_Alumbradopostes_12',
            layerName: 'layer_Alumbradopostes_12',
            pane: 'pane_Alumbradopostes_12',
            onEachFeature: pop_Alumbradopostes_12,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.marker(latlng, style_Alumbradopostes_12_0(feature));
            },
        });
        bounds_group.addLayer(layer_Alumbradopostes_12);
        // --- INICIO DEL CÓDIGO NUEVO (SISTEMA CLÁSICO) ---
        
        var baseMaps = {
            "OpenStreetMap": layer_OpenStreetMap_0,
            "Google Maps": layer_GoogleMaps_1,
            "Google Satélite": layer_GoogleMapSatellite_2,
            "Google Híbrido": layer_GoogleSatelliteHybrid_3
        };

        // --- CÓDIGO DE ÁRBOL CORREGIDO (CON GRUPOS) ---

        // --- 1. LÍMITES MUNICIPALES (Marco Dorado Institucional) ---
    function style_Limites(feature) {
        return {
            pane: 'pane_Limites',
            opacity: 1,
            color: '#C3935D',      // Dorado Oficial (Tu color)
            dashArray: '15, 5, 1, 5', // Patrón: Raya larga - punto (Estilo INEGI)
            lineCap: 'square',
            lineJoin: 'bevel',
            weight: 3.5,           // Bien grueso para que imponga autoridad
            fillOpacity: 0,
            interactive: false,    // No necesitamos darle clic a la línea
        }
    }
    
    // Creamos un "piso" (pane) especial para que esta línea siempre quede ARRIBA de todo
    map.createPane('pane_Limites');
    map.getPane('pane_Limites').style.zIndex = 600; 
    map.getPane('pane_Limites').style.pointerEvents = 'none';

    // ¡OJO AQUÍ! Revisa que 'json_Limites_municipal' sea el nombre real dentro de tu archivo .js
    /* =========================================
       PASO 1: CREACIÓN DE CAPAS DE GOBIERNO
       (Deben existir antes de meterlas al menú)
       ========================================= */

    // --- A. LÍMITES MUNICIPALES ---
    // Verificamos si los datos cargaron para que no truene la página
    /* --------------------------------------------------------
       PASO 1: CREAR LAS CAPAS NUEVAS (COCINAR)
       (Esto TIENE que ir antes del menú sí o sí)
       -------------------------------------------------------- */
    
    // CAPA 1: LÍMITES (Dorado)
    // --- A. LÍMITES MUNICIPALES (Corregido con _5) ---
    var layer_Limites; 
    
    // OJO: Aquí cambié el nombre de la variable para que coincida con tu archivo nuevo
    if (typeof json_Limitemunicipal_5 !== 'undefined') {
        layer_Limites = new L.geoJson(json_Limitemunicipal_5, { 
            style: {
                pane: 'pane_Alumbradopostes_12', 
                color: '#ffff00', // Dorado
                weight: 4,
                dashArray: '15, 5, 1, 5',
                fill: false,
                interactive: false
            }
        }).addTo(map); 
    } else {
        console.log("⚠️ ERROR: Busqué 'json_Limitemunicipal_5' y no lo hallé.");
        layer_Limites = L.layerGroup(); 
    }

    // --- B. MANZANAS (Corregido con _4) ---
    // --- B. MANZANAS (Versión Blindada: Cero Errores + Móvil) ---
    
    // 1. VARIABLE DE RASTREO (El "Vigilante")
    // Esta variable recordará qué manzana está prendida para apagarla si el mouse falla.
    // --- B. MANZANAS (Versión Final: Estilo "Luz de Oro") ---
    
    var manzanaActiva = null; 
    var layer_Manzanas;

    if (typeof json_Manzanas_4 !== 'undefined') {
        layer_Manzanas = new L.geoJson(json_Manzanas_4, {
            
            renderer: dibujanteCompartido,
            // 2. ESTILO BASE (El Fantasma Invisible)
            style: function(feature) {
                return {
                    pane: 'pane_Alumbradopostes_12',
                    color: '#ffffff' ,
                    weight: 1.2,
                    fill: true,
                    fillColor: '#ffffff',
                    fillOpacity: 0.0,
                    interactive: true
                };
            },
            
            // 3. LÓGICA DE INTERACCIÓN
            onEachFeature: function (feature, layer) {
                
                // Función para PRENDER (EL CAMBIO ESTÁ AQUÍ 👇)
                function encenderManzana(targetLayer) {
                    // Si ya hay una prendida (y no es esta), APÁGALA
                    if (manzanaActiva && manzanaActiva !== targetLayer) {
                        layer_Manzanas.resetStyle(manzanaActiva);
                    }
                    
                    // AHORA SÍ: Efecto "Luz Prendida"
                    targetLayer.setStyle({
                        weight: 3,             // Borde un pelín más grueso para resaltar
                        color: '#C3935D',      // Borde: Dorado Oficial (Serio)
                        fillColor: '#FFD700',  // Relleno: Oro Brillante (Luz)
                        fillOpacity: 0.3       // 30% Opacidad (Se nota más pero deja ver el mapa)
                    });
                    
                    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                        targetLayer.bringToFront();
                    }
                    
                    manzanaActiva = targetLayer;
                }

                // Función para APAGAR (Reset)
                function apagarManzana(targetLayer) {
                    layer_Manzanas.resetStyle(targetLayer);
                    if (manzanaActiva === targetLayer) {
                        manzanaActiva = null;
                    }
                }

                // EVENTOS
                layer.on({
                    mouseover: function(e) { encenderManzana(e.target); },
                    
                    mouseout: function(e) { 
                        if (!e.target.isPopupOpen()) { apagarManzana(e.target); } 
                    },
                    
                    click: function(e) {
                        encenderManzana(e.target);
                        map.fitBounds(e.target.getBounds());
                    },
                    
                    popupclose: function(e) { apagarManzana(e.target); }
                });

                // 4. FICHA TÉCNICA (TU DISEÑO DE LUJO)
                var props = feature.properties;
                var fichaHTML = `
                    <div style="font-family: 'Montserrat', sans-serif; min-width: 220px;">
                        <div style="background: #7E1928; color: white; padding: 10px; border-radius: 8px 8px 0 0; border-bottom: 3px solid #C3935D; text-align: center;">
                            <div style="font-size: 10px; letter-spacing: 1px; opacity: 0.8; text-transform:uppercase;">Manzana Catastral</div>
                            <div style="font-size: 16px; font-weight: 800; margin-top: 2px;">${props.CVE_MZA || 'S/N'}</div>
                        </div>

                        <div style="padding: 15px; background: #f9f9f9; border: 1px solid #ddd; border-top: none; border-radius: 0 0 8px 8px;">
                            <div style="margin-bottom: 12px; text-align: center;">
                                <span style="font-size: 10px; color: #666; display: block; margin-bottom: 2px;">CLAVE ÚNICA (CVEGEO)</span>
                                <span style="background: #eef2f5; color: #333; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 13px; font-weight: bold; border: 1px solid #ccc; display: block; letter-spacing:1px;">
                                    ${props.CVEGEO || 'Sin Dato'}
                                </span>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                                <div><strong style="color: #7E1928;">MUNICIPIO</strong><br>${props.CVE_MUN || '-'}</div>
                                <div><strong style="color: #7E1928;">LOCALIDAD</strong><br>${props.CVE_LOC || '-'}</div>
                                <div><strong style="color: #7E1928;">AGEB</strong><br>${props.CVE_AGEB || '-'}</div>
                                <div><strong style="color: #7E1928;">ÁMBITO</strong><br>${props.AMBITO || '-'}</div>
                            </div>

                            <div style="margin-top: 12px; border-top: 1px dashed #ccc; padding-top: 8px; font-size: 10px; text-align: center; color: #888;">
                                TIPO: <strong style="color: #444;">${props.TIPOMZA || 'Estándar'}</strong>
                            </div>
                        </div>
                    </div>
                `;

                layer.bindPopup(fichaHTML, { maxWidth: 300, className: 'popup-manzana-custom' });
            }
        }).addTo(map);
    } else {
        console.log("⚠️ ERROR: No encuentro json_Manzanas_4");
        layer_Manzanas = L.layerGroup();
    }
    /* --------------------------------------------------------
       PASO 2: CREAR EL MENÚ (SERVIR)
       (Ahora sí podemos usar las variables de arriba)
       -------------------------------------------------------- */

    // --- C. VIALIDADES (Red de Calles) ---
    // --- C. VIALIDADES (Versión Blindada Anti-Crashes) ---
    
    // 1. VARIABLE DE RASTREO (El Vigilante de Calles)
    // --- C. VIALIDADES (Modo Turbo con Canvas) ---
    
    var vialidadActiva = null;
    // --- C. VIALIDADES (Versión Pro: Limpia nombres y muestra Claves) ---
    var layer_Vialidades;

    if (typeof json_Vialidades_6 !== 'undefined') {
        layer_Vialidades = new L.geoJson(json_Vialidades_6, {
            
            // 🔥 USAMOS EL DIBUJANTE COMPARTIDO (Para que no bloquee las manzanas)
            renderer: dibujanteCompartido,
            
            // 1. ESTILO TÉCNICO
            style: function(feature) {
                return {
                    pane: 'pane_Alumbradopostes_12', 
                    color: '#636e72',      // Gris Asfalto
                    weight: 3,             
                    opacity: 0.8,
                    dashArray: '5, 7',     
                    interactive: true
                };
            },
            
            // 2. INTERACCIÓN
            onEachFeature: function (feature, layer) {
                
                layer.on({
                    mouseover: function(e) {
                        var layer = e.target;
                        layer.setStyle({
                            color: '#2c3e50', 
                            weight: 5,        
                            dashArray: '',    
                            opacity: 1
                        });
                        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                            layer.bringToFront();
                        }
                    },
                    mouseout: function(e) {
                        layer_Vialidades.resetStyle(e.target);
                    },
                    click: function(e) {
                        map.fitBounds(e.target.getBounds());
                    }
                });

                // 3. LÓGICA INTELIGENTE DE NOMBRES
                // 3. LÓGICA NIVEL EXPERTO (Respeta si es Calle, Privada o Avenida)
                var props = feature.properties;
                
                var tipo = props.TIPOVIAL || '';       // Ej: "Privada", "Calle", "Avenida"
                var nombreRaw = props.NOMVIAL || '';   // Ej: "Ninguno", "Juarez"

                // 1. Si el nombre es "Ninguno", lo cambiamos a "SIN NOMBRE"
                if (nombreRaw.toLowerCase() === 'ninguno') {
                    nombreRaw = 'SIN NOMBRE';
                }

                // 2. Unimos. Ej: "Privada" + "SIN NOMBRE" = "PRIVADA SIN NOMBRE"
                var nombreCompleto = (tipo + ' ' + nombreRaw).trim();
                
                // 3. Si por alguna razón quedó vacío, usamos el genérico
                if (nombreCompleto === "" || nombreCompleto === "SIN NOMBRE") {
                    nombreCompleto = "VIALIDAD SIN NOMBRE";
                }

                // 4. FICHA TÉCNICA MEJORADA
                var fichaCalle = `
                    <div style="font-family: 'Montserrat', sans-serif; min-width: 240px;">
                        
                        <div style="background: #34495e; color: white; padding: 8px; border-radius: 6px 6px 0 0; border-bottom: 3px solid #C3935D; text-align: center;">
                            <div style="font-size: 8px; letter-spacing: 1px; opacity:0.8;">CLAVE DE VIALIDAD</div>
                            <div style="font-size: 14px; font-weight: 800; letter-spacing: 2px;">
                                ${props.CVEVIAL || 'S/N'}
                            </div>
                        </div>

                        <div style="padding: 15px; background: white; border: 1px solid #ccc; border-top: none; border-radius: 0 0 6px 6px;">
                            <div style="text-align: center; margin-bottom: 10px;">
                                <div style="font-size: 10px; color: #7f8c8d; font-weight: 600; margin-bottom: 4px; text-transform: uppercase;">NOMBRE PÚBLICO</div>
                                <div style="font-size: 15px; font-weight: 800; color: #2c3e50; text-transform: uppercase; line-height: 1.2;">
                                    ${nombreCompleto}
                                </div>
                            </div>
                            
                            <div style="border-top: 1px dashed #eee; padding-top: 8px; font-size: 11px; color: #666; display: flex; align-items: center; justify-content: center;">
                                <span style="margin-right: 5px;">SENTIDO:</span> 
                                <strong style="color: #333;">${props.SENTIDO || 'No Definido'}</strong>
                            </div>
                        </div>
                    </div>
                `;

                layer.bindPopup(fichaCalle, { className: 'popup-calle-custom' });
            }
        }).addTo(map); 
    } else {
        console.log("⚠️ No encuentro json_Vialidades_6");
        layer_Vialidades = L.layerGroup();
    }

    // --- D. AGEBS (Zonificación de Barrios) ---
    var layer_AGEB;

    // 👇 AQUÍ ESTÁ LA CORRECCIÓN: Usamos 'json_AGEB_6'
    if (typeof json_AGEB_6 !== 'undefined') {
        layer_AGEB = new L.geoJson(json_AGEB_6, {
            
            // Usamos el dibujante compartido (Canvas)
            renderer: dibujanteCompartido,
            
            // ESTILO: Marco Morado
            style: function(feature) {
                return {
                    pane: 'pane_Alumbradopostes_12',
                    color: '#6c5ce7',       // Morado
                    weight: 2,
                    opacity: 0.8,
                    fill: false,            // SIN RELLENO (Importante)
                    interactive: true
                };
            },
            
            // INTERACCIÓN
            onEachFeature: function (feature, layer) {
                
                // Efecto Hover
                layer.on({
                    mouseover: function(e) {
                        var layer = e.target;
                        layer.setStyle({
                            weight: 4,
                            color: '#8e44ad',
                            opacity: 1
                        });
                        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                            layer.bringToFront();
                        }
                    },
                    mouseout: function(e) {
                        layer_AGEB.resetStyle(e.target);
                    }
                });

                // ETIQUETA FLOTANTE (CLAVE DE BARRIO)
                if (feature.properties['CVE_AGEB']) {
                    layer.bindTooltip(
                        `<div style="font-weight:900; font-size:10px; color:#6c5ce7; text-shadow: 1px 1px 0 #fff;">
                            ${feature.properties['CVE_AGEB']}
                        </div>`,
                        { permanent: true, direction: "center", className: "label-ageb" }
                    );
                }

                // FICHA TÉCNICA
                // FICHA TÉCNICA PRO (Con Clave Única)
                var props = feature.properties;
                
                var popupAGEB = `
                    <div style="text-align:center; font-family: 'Montserrat', sans-serif; min-width: 200px;">
                        
                        <div style="background: #6c5ce7; color: white; padding: 10px; border-radius: 6px 6px 0 0; text-transform: uppercase;">
                            <div style="font-size: 10px; letter-spacing: 1px; opacity: 0.9;">ZONA (AGEB)</div>
                            <div style="font-size: 22px; font-weight: 800; margin-top: 0px;">
                                ${props.CVE_AGEB || 'S/N'}
                            </div>
                        </div>

                        <div style="padding: 15px; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 6px 6px;">
                            <div style="margin-bottom: 5px;">
                                <span style="font-size: 9px; color: #888; font-weight: 700; display: block; margin-bottom: 3px;">CLAVE ÚNICA NACIONAL (CVEGEO)</span>
                                <span style="background: #f0f3f6; color: #2c3e50; padding: 5px 10px; border-radius: 4px; font-family: monospace; font-size: 14px; font-weight: bold; border: 1px solid #dcdcdc; display: block; letter-spacing: 0.5px;">
                                    ${props.CVEGEO || 'Sin Dato'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                layer.bindPopup(popupAGEB, { className: 'popup-ageb-custom' });
            }
        }); 
    } else {
        console.log("⚠️ No encuentro la variable json_AGEB_6");
        layer_AGEB = L.layerGroup();
    }

    var overlaysTree = [
        // GRUPO 1: CATASTRO
        {
            label: '<b>Catastro Municipal</b>',
            selectAllCheckbox: true,
            collapsed: false,
            children: [
                {label: "📍 Límite Municipal", layer: layer_Limites},
                {label: "🟣 Zonificación (AGEBs)", layer: layer_AGEB},
                {label: "⬜ Traza Urbana (Manzanas)", layer: layer_Manzanas},
                {label: "🛣️ Red Vial (Nombres)", layer: layer_Vialidades},
            ]
        },

        // GRUPO 3: INFRAESTRUCTURA (Lámparas)
        {
            label: '<b>Infraestructura</b>',
            selectAllCheckbox: true,
            collapsed: true,
            children: [
                {label: '⚫ Apagada', layer: layer_Apagada_11},
                {label: '🟢 Operativo (Bueno)', layer: layer_Bueno_10},
                {label: '🔴 Dañado', layer: layer_Daado_9},
                {label: '🟡 Directa', layer: layer_Directa_8},
                {label: '🟣 Intermitente', layer: layer_Intermitente_7},
                {label: '🟠 Otro', layer: layer_Otro_6},
            ]
        },

        // GRUPO 4: ORTOFOTOS
        {
            label: '<b>Ortofotos</b>',
            selectAllCheckbox: true,
            collapsed: true,
            children: [
                {label: "Ortofoto Parte 1", layer: layer_dji_fly_20250722_185256_0182_1769184314666_photo_modified_5},
                {label: "Ortofoto Parte 2", layer: layer_dji_fly_20250722_185244_0181_1769184310403_photo_modified_4},
            ]
        },
        {
            label: '<b>Mapas Base</b>',
            selectAllCheckbox: false, 
            collapsed: true, 
            children: [
                {label: "🛰️ Google Híbrido", layer: layer_GoogleSatelliteHybrid_3, radioGroup: 'bm' },
                {label: "🌍 Google Satélite", layer: layer_GoogleMapSatellite_2, radioGroup: 'bm' },
                {label: "🗺️ Google Maps", layer: layer_GoogleMaps_1, radioGroup: 'bm' },
                {label: "🏙️ OpenStreetMap", layer: layer_OpenStreetMap_0, radioGroup: 'bm' },
            ]
        }
    ];

    // DIBUJAR EL CONTROL
    var isMobile = window.innerWidth < 768;
    var lay = L.control.layers.tree(null, overlaysTree, {
        namedToggle: false,
        selectorBack: false,
        collapsed: isMobile,
    });
    
    lay.addTo(map);
        
        //setBounds();
        var i = 0;
        layer_Otro_6.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Id'] !== null?String('<div style="color: #000000; font-size: 10pt; font-weight: bold; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['Id']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Otro_6'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        var i = 0;
        layer_Intermitente_7.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Id'] !== null?String('<div style="color: #000000; font-size: 10pt; font-weight: bold; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['Id']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Intermitente_7'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        var i = 0;
        layer_Directa_8.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Id'] !== null?String('<div style="color: #000000; font-size: 10pt; font-weight: bold; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['Id']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Directa_8'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        var i = 0;
        layer_Daado_9.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Id'] !== null?String('<div style="color: #000000; font-size: 10pt; font-weight: bold; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['Id']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Daado_9'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        var i = 0;
        layer_Bueno_10.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Id'] !== null?String('<div style="color: #000000; font-size: 10pt; font-weight: bold; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['Id']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Bueno_10'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        var i = 0;
        layer_Apagada_11.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Id'] !== null?String('<div style="color: #000000; font-size: 10pt; font-weight: bold; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['Id']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Apagada_11'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        
        map.addControl(new L.Control.Search({
            layer: layer_Alumbradopostes_12,
            initial: false,
            hideMarkerOnCollapse: true,
            propertyName: 'Id'}));
        if (typeof url === 'undefined') {
            document.getElementsByClassName('search-button')[0].className += ' fa fa-binoculars';
        } else {
            document.getElementsByClassName('search-button')[1].className += ' fa fa-binoculars';
        }
        L.ImageOverlay.include({
            getBounds: function () {
                return this._bounds;
            }
        });
        resetLabels([layer_Otro_6,layer_Intermitente_7,layer_Directa_8,layer_Daado_9,layer_Bueno_10,layer_Apagada_11]);
        map.on("zoomend", function(){
            resetLabels([layer_Otro_6,layer_Intermitente_7,layer_Directa_8,layer_Daado_9,layer_Bueno_10,layer_Apagada_11]);
        });
        map.on("layeradd", function(){
            resetLabels([layer_Otro_6,layer_Intermitente_7,layer_Directa_8,layer_Daado_9,layer_Bueno_10,layer_Apagada_11]);
        });
        map.on("layerremove", function(){
            resetLabels([layer_Otro_6,layer_Intermitente_7,layer_Directa_8,layer_Daado_9,layer_Bueno_10,layer_Apagada_11]);
        });
        
        </script>    
        
        <div id="image-modal" class="modal-overlay" onclick="closeModal()">
  <span class="close-modal">&times;</span>
  <img class="modal-content" id="full-image">
</div>
    
    <script>
        // 1. Función para CERRAR el visor (la llama el onclick del HTML)
        function closeModal() {
            document.getElementById("image-modal").style.display = "none";
        }

        // 2. DETECTOR DE CLICS "A PRUEBA DE FALLOS"
        // Este código vigila cualquier clic que hagas en la pantalla
        document.addEventListener('click', function(e) {
            
            // ¿Le diste clic a una IMAGEN (IMG) que está dentro de un POPUP?
            if (e.target && e.target.tagName === 'IMG' && e.target.closest('.leaflet-popup-content')) {
                
                // ¡SÍ! Entonces detenemos lo que sea que iba a hacer el navegador
                e.preventDefault();
                e.stopPropagation();

                // Buscamos tu caja negra y la imagen gigante
                var modal = document.getElementById("image-modal");
                var modalImg = document.getElementById("full-image");
                
                // La mostramos en pantalla
                modal.style.display = "flex";
                modal.style.alignItems = "center";
                modal.style.justifyContent = "center";
                
                // Le pasamos la foto que tocaste para que se vea grande
                modalImg.src = e.target.src;
            }
        });
    </script>


    <div id="chart-modal" class="modal-overlay" onclick="closeChart()">
    <div class="chart-card-drobot" onclick="event.stopPropagation()">
        <div class="chart-header-drobot">
            <span class="chart-title"><i class="fas fa-chart-pie"></i> Diagnóstico Estadístico</span>
            <span class="close-chart-btn" onclick="closeChart()">&times;</span>
        </div>
        
        <div class="chart-body-drobot">
            <canvas id="drobotChart"></canvas>
        </div>
        
        <div class="chart-controls-drobot">
            <button class="chart-btn active" onclick="updateChartType('bar', this)" title="Barras">
                <i class="fas fa-chart-bar"></i> Barras
            </button>
            <button class="chart-btn" onclick="updateChartType('doughnut', this)" title="Dona">
                 <i class="fas fa-circle-notch"></i> Dona
            </button>
            <button class="chart-btn" onclick="updateChartType('pie', this)" title="Pastel">
                <i class="fas fa-chart-pie"></i> Pastel
            </button>
             <button class="chart-btn" onclick="updateChartType('line', this)" title="Tendencia">
                <i class="fas fa-chart-line"></i> Línea
            </button>
        </div>
    </div>
</div>


    <style>
    /* --- ESTILOS DEL DASHBOARD DROBOT --- */
    .chart-card-drobot {
        background: white;
        border-radius: 16px; /* Bordes más suaves */
        width: 95%;
        max-width: 700px; /* Un poco más ancho */
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        overflow: hidden; /* Para que el header azul no se salga de las esquinas */
        display: flex;
        flex-direction: column;
        animation: slideUp 0.4s ease;
    }

    /* 1. Header Azul */
    .chart-header-drobot {
        background: linear-gradient(90deg, #0b1c2c 0%, #1a2e40 100%); /* Mismo azul que la barra principal */
        color: white;
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .chart-title { font-weight: 700; font-size: 18px; letter-spacing: 0.5px; }
    .close-chart-btn { font-size: 28px; cursor: pointer; color: rgba(255,255,255,0.8); transition: 0.2s; }
    .close-chart-btn:hover { color: white; }

    /* 2. Cuerpo */
    .chart-body-drobot {
        padding: 25px;
        height: 350px; /* Altura fija para la gráfica */
        position: relative;
    }

    /* 3. Controles (Botones inferiores) */
    .chart-controls-drobot {
        padding: 15px 25px;
        background: #f8f9fa; /* Gris muy clarito */
        border-top: 1px solid #eee;
        display: flex;
        justify-content: center;
        gap: 10px; /* Espacio entre botones */
    }
    .chart-btn {
        background: white;
        border: 1px solid #ddd;
        padding: 10px 20px;
        border-radius: 30px; /* Botones tipo pastilla */
        cursor: pointer;
        font-family: 'Montserrat', sans-serif;
        font-weight: 600;
        color: #555;
        transition: all 0.3s ease;
        display: flex; align-items: center; gap: 8px;
    }
    .chart-btn i { font-size: 16px; }
    
    /* Estado Activo y Hover */
    .chart-btn:hover { background: #f0f0f0; transform: translateY(-2px); }
    .chart-btn.active {
        background: #0b1c2c; /* Azul Drobot cuando está seleccionado */
        color: white;
        border-color: #0b1c2c;
        box-shadow: 0 4px 10px rgba(11, 28, 44, 0.3);
    }
    @keyframes slideUp { from {transform:translateY(50px); opacity:0} to {transform:translateY(0); opacity:1} }

    /* --- ESTILO DE LA CAJA BLANCA DEL LOGO --- */
        .logo-box {
    background-color: white;
    padding: 5px 12px;
    border-radius: 6px;
    margin-right: 15px;
    /* Antes 50px, ahora 60px (más alta) */
    height: 60px; 
    display: flex;
    align-items: center; /* Esto centra el logo verticalmente a fuerza */
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

        /* Ajuste para que la imagen se acomode dentro de la caja */
        #drobot-logo { 
            height: 90%;   /* Que ocupe casi toda la caja */
            width: auto;
            margin-right: 0; /* Quitamos el margen viejo */
            display: block; 
            filter: none;    /* Quitamos filtros anteriores si había */
        }
</style>

<script>
    // --- 1. BOTÓN EN EL MAPA (Igual que antes) ---
    L.Control.Graph = L.Control.extend({
        onAdd: function(map) {
            // Usamos el icono de pastel de FontAwesome para que se vea pro
            var div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            div.innerHTML = '<a href="#" title="Ver Dashboard" role="button" onclick="openChart(event)" style="display:flex; align-items:center; justify-content:center;"><i class="fas fa-chart-pie" style="font-size:20px;"></i></a>';
            return div;
        }
    });
    new L.Control.Graph({ position: 'topleft' }).addTo(map);

    // --- 2. LÓGICA AVANZADA DE GRÁFICAS ---
    var myChart; // Variable global para la instancia de la gráfica
    // Variables globales para los datos (para no recalcularlos siempre)
    var globalData = [];
    var globalLabels = ['Apagada', 'Operativo', 'Dañado', 'Directa', 'Intermitente', 'Otro'];
    var globalColors = ['#333333', '#2ecc71', '#e74c3c', '#f1c40f', '#9b59b6', '#e67e22'];

    // Función para abrir el modal y cargar datos por primera vez
    function openChart(e) {
        if(e) e.preventDefault();
        document.getElementById("chart-modal").style.display = "flex";
        document.getElementById("chart-modal").style.alignItems = "center";
        document.getElementById("chart-modal").style.justifyContent = "center";

        // Si ya calculamos los datos, solo actualizamos el tipo a Barras por defecto
        if (globalData.length > 0) {
             // Reseteamos botones visualmente
             resetButtons();
             document.querySelector('.chart-btn[onclick*="bar"]').classList.add('active');
             updateChartType('bar', null); // null porque ya activamos el botón manualmente
             return;
        }

        // --- CONTAR DATOS UNA SOLA VEZ ---
        globalData = [
            json_Apagada_11.features.length,
            json_Bueno_10.features.length,
            json_Daado_9.features.length,
            json_Directa_8.features.length,
            json_Intermitente_7.features.length,
            json_Otro_6.features.length
        ];

        // Crear la primera gráfica (Barras por defecto)
        createChart('bar');
    }

    // Función para CERRAR
    function closeChart() {
        document.getElementById("chart-modal").style.display = "none";
    }

    // --- FUNCIÓN CLAVE: CAMBIAR EL TIPO DE GRÁFICA ---
    function updateChartType(newType, btnElement) {
        // 1. Manejo visual de los botones (si se hizo clic en uno)
        if (btnElement) {
            resetButtons();
            btnElement.classList.add('active'); // Activar el botón clickeado
        }

        // 2. Destruir la gráfica anterior si existe (OBLIGATORIO en Chart.js)
        if (myChart) {
            myChart.destroy();
        }

        // 3. Crear la nueva gráfica con el nuevo tipo
        createChart(newType);
    }

    // Función auxiliar para resetear estilo de botones
    function resetButtons() {
         var btns = document.querySelectorAll('.chart-btn');
         btns.forEach(btn => btn.classList.remove('active'));
    }

    // Función auxiliar para crear la instancia de Chart.js
    function createChart(type) {
        var ctx = document.getElementById('drobotChart').getContext('2d');
        
        // Configuración base
        var config = {
            type: type,
            data: {
                labels: globalLabels,
                datasets: [{
                    label: 'Cantidad',
                    data: globalData,
                    backgroundColor: globalColors,
                    borderWidth: 2,
                    borderColor: '#ffffff',
                    borderRadius: type === 'bar' ? 8 : 0, // Redondear solo si es barras
                    hoverOffset: 10 // Efecto al pasar el mouse en pastel/dona
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: type !== 'bar' && type !== 'line', // Mostrar leyenda solo en pastel/dona
                        position: 'bottom',
                         labels: { font: { family: 'Montserrat', size: 12 } }
                    },
                    tooltip: {
                        backgroundColor: '#0b1c2c',
                        titleFont: { family: 'Montserrat' },
                        bodyFont: { family: 'Montserrat' }
                    }
                },
                scales: {
                    // Ocultar ejes X/Y si es pastel o dona, mostrarlos si es barra o línea
                    x: { display: type === 'bar' || type === 'line' },
                    y: { display: type === 'bar' || type === 'line', beginAtZero: true }
                },
                 elements: {
                    line: { tension: 0.4 } // Hacer las líneas curvas (suaves)
                }
            }
        };

        myChart = new Chart(ctx, config);
    }
</script>

    </body>
</html>
